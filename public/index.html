<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bid Tac Toe</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            background: #0f0f1a;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            color: #e0e0e0;
        }

        .game-wrapper {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 20px;
        }

        h1 {
            font-size: 32px;
            background: linear-gradient(135deg, #f7971e, #ffd200);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            letter-spacing: 2px;
        }

        .subtitle {
            color: #888;
            font-size: 14px;
            margin-top: -12px;
        }

        /* Lobby */
        .lobby {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 16px;
            padding: 32px;
            background: #1a1a2e;
            border: 2px solid #333;
            border-radius: 16px;
            min-width: 360px;
        }

        .lobby input {
            width: 100%;
            padding: 10px 14px;
            border: 2px solid #333;
            border-radius: 8px;
            background: #0f0f1a;
            color: #e0e0e0;
            font-size: 16px;
            font-family: inherit;
            outline: none;
            transition: border-color 0.2s;
        }

        .lobby input:focus {
            border-color: #ffd200;
        }

        .lobby-row {
            display: flex;
            gap: 10px;
            width: 100%;
        }

        .lobby-btn {
            flex: 1;
            padding: 12px 20px;
            border: 2px solid #333;
            border-radius: 10px;
            background: transparent;
            color: #e0e0e0;
            font-size: 15px;
            font-weight: bold;
            cursor: pointer;
            font-family: inherit;
            transition: all 0.2s;
        }

        .lobby-btn:hover {
            border-color: #ffd200;
            color: #ffd200;
        }

        .lobby-btn.primary {
            background: linear-gradient(135deg, #f7971e, #ffd200);
            color: #0f0f1a;
            border-color: transparent;
        }

        .lobby-btn.primary:hover {
            transform: scale(1.03);
            box-shadow: 0 4px 20px rgba(255, 210, 0, 0.3);
        }

        .game-id-display {
            display: none;
            flex-direction: column;
            align-items: center;
            gap: 8px;
            padding: 16px;
            background: #12121f;
            border-radius: 10px;
            width: 100%;
        }

        .game-id-display .code {
            font-size: 28px;
            font-weight: bold;
            color: #ffd200;
            letter-spacing: 4px;
            cursor: pointer;
        }

        .game-id-display .hint {
            font-size: 13px;
            color: #666;
        }

        .waiting-msg {
            display: none;
            color: #888;
            font-size: 14px;
            animation: pulse 1.5s ease-in-out infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 0.5; }
            50% { opacity: 1; }
        }

        .join-section {
            display: none;
            width: 100%;
            gap: 10px;
            flex-direction: column;
        }

        .lobby-error {
            color: #ff6b6b;
            font-size: 13px;
            display: none;
        }

        /* Scoreboard */
        .game-screen { display: none; }

        .scoreboard {
            display: flex;
            gap: 40px;
            align-items: center;
        }

        .player-info {
            text-align: center;
            padding: 14px 24px;
            border-radius: 12px;
            background: #1a1a2e;
            border: 2px solid #333;
            min-width: 140px;
            transition: border-color 0.3s, box-shadow 0.3s;
        }

        .player-info.active {
            border-color: #ffd200;
            box-shadow: 0 0 20px rgba(255, 210, 0, 0.15);
        }

        .player-info.you {
            border-color: #4ecdc4;
        }

        .player-info .label {
            font-size: 13px;
            text-transform: uppercase;
            letter-spacing: 1px;
            color: #888;
            margin-bottom: 4px;
            overflow: hidden;
            text-overflow: ellipsis;
            max-width: 120px;
        }

        .player-info .symbol {
            font-size: 28px;
            font-weight: bold;
            margin-bottom: 4px;
        }

        .player-info.x-player .symbol { color: #ff6b6b; }
        .player-info.o-player .symbol { color: #4ecdc4; }

        .player-info .money {
            font-size: 22px;
            font-weight: bold;
            color: #ffd200;
        }

        .vs {
            font-size: 18px;
            color: #555;
            font-weight: bold;
        }

        /* Status + turn actions row */
        .status-row {
            display: flex;
            align-items: center;
            gap: 16px;
            min-height: 40px;
        }

        .status {
            font-size: 16px;
            color: #ccc;
            text-align: center;
        }

        .status.win { color: #ffd200; font-weight: bold; }
        .status.lose { color: #ff6b6b; font-weight: bold; }

        /* Turn tracker pills */
        .turn-actions {
            display: none;
            gap: 8px;
            align-items: center;
        }

        .action-pill {
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: bold;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            border: 1px solid #333;
            background: #1a1a2e;
            color: #555;
        }

        .action-pill.available {
            color: #aaa;
            border-color: #555;
        }

        .action-pill.used {
            color: #ffd200;
            border-color: #ffd200;
            background: rgba(255, 210, 0, 0.1);
        }

        .end-turn-btn {
            padding: 8px 22px;
            border: 2px solid #4ecdc4;
            border-radius: 10px;
            background: rgba(78, 205, 196, 0.1);
            color: #4ecdc4;
            font-size: 14px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.2s;
            font-family: inherit;
            display: none;
        }

        .end-turn-btn.visible {
            display: inline-block;
        }

        .end-turn-btn:hover {
            background: rgba(78, 205, 196, 0.2);
            box-shadow: 0 0 15px rgba(78, 205, 196, 0.2);
        }

        /* Board */
        .board {
            display: grid;
            grid-template-columns: repeat(3, 120px);
            grid-template-rows: repeat(3, 120px);
            gap: 6px;
        }

        .cell {
            background: #1a1a2e;
            border: 2px solid #2a2a40;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 48px;
            font-weight: bold;
            cursor: pointer;
            transition: background 0.2s, border-color 0.2s, transform 0.15s;
            position: relative;
        }

        .cell:hover {
            background: #22223a;
            border-color: #ffd200;
            transform: scale(1.03);
        }

        .cell .x-mark { color: #ff6b6b; }
        .cell .o-mark { color: #4ecdc4; }

        .cell .bid-tag {
            position: absolute;
            bottom: 6px;
            right: 8px;
            font-size: 11px;
            color: #666;
            font-weight: normal;
            display: none;
        }

        .cell.reveal-bid .bid-tag {
            display: block;
        }

        .cell.win-cell {
            background: rgba(255, 210, 0, 0.1);
            border-color: #ffd200;
            box-shadow: 0 0 20px rgba(255, 210, 0, 0.2);
        }

        .cell.just-placed {
            border-color: #ffd200;
            animation: popIn 0.3s ease;
        }

        @keyframes popIn {
            0% { transform: scale(0.85); }
            50% { transform: scale(1.08); }
            100% { transform: scale(1); }
        }

        /* Modal */
        .modal-backdrop {
            position: fixed;
            top: 0; left: 0;
            width: 100%; height: 100%;
            background: rgba(0, 0, 0, 0.7);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 100;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s;
        }

        .modal-backdrop.show {
            opacity: 1;
            pointer-events: all;
        }

        .modal {
            background: #1a1a2e;
            border: 2px solid #333;
            border-radius: 16px;
            padding: 28px 32px;
            text-align: center;
            min-width: 300px;
            transform: scale(0.9);
            transition: transform 0.3s;
        }

        .modal-backdrop.show .modal {
            transform: scale(1);
        }

        .modal h3 {
            font-size: 20px;
            margin-bottom: 8px;
            color: #fff;
        }

        .modal p {
            color: #999;
            font-size: 14px;
            margin-bottom: 20px;
        }

        .bid-input-group {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            margin-bottom: 20px;
        }

        .bid-input-group label {
            color: #999;
            font-size: 14px;
        }

        .bid-input-group input {
            width: 80px;
            padding: 8px 12px;
            border: 2px solid #333;
            border-radius: 8px;
            background: #0f0f1a;
            color: #ffd200;
            font-size: 18px;
            font-weight: bold;
            text-align: center;
            font-family: inherit;
            outline: none;
            transition: border-color 0.2s;
        }

        .bid-input-group input:focus {
            border-color: #ffd200;
        }

        .confirm-btn {
            padding: 10px 36px;
            border: none;
            border-radius: 10px;
            background: linear-gradient(135deg, #f7971e, #ffd200);
            color: #0f0f1a;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
            font-family: inherit;
        }

        .confirm-btn:hover {
            transform: scale(1.05);
            box-shadow: 0 4px 20px rgba(255, 210, 0, 0.3);
        }

        /* Toast */
        .toast {
            position: fixed;
            top: 30px;
            left: 50%;
            transform: translateX(-50%) translateY(-80px);
            background: #1a1a2e;
            border: 2px solid #333;
            border-radius: 10px;
            padding: 12px 24px;
            font-size: 15px;
            z-index: 200;
            transition: transform 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
            white-space: nowrap;
        }

        .toast.show {
            transform: translateX(-50%) translateY(0);
        }

        .toast.success { border-color: #4ecdc4; color: #4ecdc4; }
        .toast.fail { border-color: #ff6b6b; color: #ff6b6b; }
        .toast.info { border-color: #ffd200; color: #ffd200; }

        /* Log */
        .log {
            max-height: 120px;
            overflow-y: auto;
            width: 378px;
            background: #12121f;
            border-radius: 10px;
            padding: 10px 14px;
            font-size: 12px;
            color: #666;
            line-height: 1.6;
        }

        .log::-webkit-scrollbar { width: 4px; }
        .log::-webkit-scrollbar-thumb { background: #333; border-radius: 4px; }

        .log .entry-x { color: #ff6b6b; }
        .log .entry-o { color: #4ecdc4; }
        .log .entry-gold { color: #ffd200; }
        .log .entry-divider { color: #333; }

        /* Rules tooltip */
        .rules-btn {
            padding: 6px 16px;
            border: 1px solid #333;
            border-radius: 8px;
            background: transparent;
            color: #666;
            font-size: 12px;
            cursor: pointer;
            font-family: inherit;
            transition: all 0.2s;
        }

        .rules-btn:hover { border-color: #888; color: #aaa; }

        .rules-panel {
            display: none;
            width: 378px;
            background: #12121f;
            border: 1px solid #333;
            border-radius: 10px;
            padding: 14px 18px;
            font-size: 13px;
            color: #888;
            line-height: 1.7;
            text-align: left;
        }

        .rules-panel.show { display: block; }
        .rules-panel strong { color: #ffd200; }

        .back-btn {
            padding: 8px 20px;
            border: 2px solid #333;
            border-radius: 10px;
            background: transparent;
            color: #888;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.2s;
            font-family: inherit;
        }

        .back-btn:hover {
            border-color: #ffd200;
            color: #ffd200;
        }

        .disconnected-banner {
            display: none;
            background: rgba(255, 107, 107, 0.1);
            border: 1px solid #ff6b6b;
            border-radius: 8px;
            padding: 8px 16px;
            color: #ff6b6b;
            font-size: 14px;
        }
    </style>
</head>
<body>
    <div class="game-wrapper">
        <h1>BID TAC TOE</h1>
        <div class="subtitle">Outbid. Outplay. Outwin.</div>

        <!-- Lobby Screen -->
        <div class="lobby" id="lobby">
            <input type="text" id="usernameInput" placeholder="Enter your name" maxlength="20">
            <div class="lobby-row">
                <button class="lobby-btn primary" onclick="createGame()">Create Game</button>
                <button class="lobby-btn" onclick="showJoinSection()">Join Game</button>
            </div>
            <div class="game-id-display" id="gameIdDisplay">
                <div class="hint">Share this code with your opponent:</div>
                <div class="code" id="gameCode" onclick="copyGameCode()"></div>
                <div class="hint">Click to copy</div>
            </div>
            <div class="waiting-msg" id="waitingMsg">Waiting for opponent to join...</div>
            <div class="join-section" id="joinSection">
                <input type="text" id="gameIdInput" placeholder="Enter game code" maxlength="6" style="text-transform:uppercase;text-align:center;letter-spacing:4px;font-size:20px;">
                <button class="lobby-btn primary" onclick="joinGame()">Join</button>
            </div>
            <div class="lobby-error" id="lobbyError"></div>
        </div>

        <!-- Game Screen -->
        <div class="game-screen" id="gameScreen">
            <div class="disconnected-banner" id="disconnectedBanner">Opponent disconnected</div>

            <div class="scoreboard">
                <div class="player-info x-player" id="playerX">
                    <div class="label" id="labelX">X</div>
                    <div class="symbol">X</div>
                    <div class="money" id="moneyX">$100</div>
                </div>
                <div class="vs">VS</div>
                <div class="player-info o-player" id="playerO">
                    <div class="label" id="labelO">O</div>
                    <div class="symbol">O</div>
                    <div class="money" id="moneyO">$100</div>
                </div>
            </div>

            <div class="status-row">
                <div class="status" id="status">Waiting...</div>
                <div class="turn-actions" id="turnActions">
                    <span class="action-pill" id="pillPlace">Place</span>
                    <span class="action-pill" id="pillRemove">Remove</span>
                </div>
                <button class="end-turn-btn" id="endTurnBtn" onclick="endTurn()">End Turn</button>
            </div>

            <div class="board" id="board"></div>

            <div class="log" id="log"></div>

            <div style="display:flex;gap:12px;">
                <button class="back-btn" onclick="backToLobby()">Leave</button>
                <button class="rules-btn" onclick="toggleRules()">Rules</button>
            </div>

            <div class="rules-panel" id="rulesPanel">
                Both players start with <strong>$100</strong>. On each turn you get <strong>2 possible actions</strong>:<br>
                1. <strong>Place</strong> your coin on an empty cell (costs a bid)<br>
                2. <strong>Remove</strong> opponent's coin (bid more than they paid to succeed)<br>
                You can do <strong>both, or just one</strong>, then end your turn.<br>
                If your remove bid is too low, you <strong>lose your money</strong> and their coin stays.<br>
                Bids are <strong>hidden</strong> — revealed at game end.<br>
                <strong>Go bankrupt</strong> or get <strong>3 in a row</strong> to decide the winner!
            </div>
        </div>
    </div>

    <!-- Bid Modal -->
    <div class="modal-backdrop" id="modal">
        <div class="modal">
            <h3 id="modalTitle">Place your coin</h3>
            <p id="modalDesc">How much will you bid?</p>
            <div class="bid-input-group">
                <label>Bid: $</label>
                <input type="number" id="bidInput" min="1" max="100" value="5">
            </div>
            <button class="confirm-btn" onclick="confirmBid()">Confirm</button>
        </div>
    </div>

    <div class="toast" id="toast"></div>

    <script>
        // --- State ---
        var ws = null;
        var mySymbol = null;
        var gameState = null;
        var selectedCell = -1;
        var selectedAction = '';
        var isGameOver = false;
        var opponentName = '';
        var myUsername = '';

        // --- WebSocket ---
        function connectWS() {
            var protocol = location.protocol === 'https:' ? 'wss:' : 'ws:';
            ws = new WebSocket(protocol + '//' + location.host);

            ws.onopen = function() {};

            ws.onmessage = function(e) {
                var msg = JSON.parse(e.data);
                handleMessage(msg);
            };

            ws.onclose = function() {
                if (!isGameOver) {
                    showToast('Connection lost', 'fail');
                }
            };
        }

        function sendMsg(obj) {
            if (ws && ws.readyState === 1) {
                ws.send(JSON.stringify(obj));
            }
        }

        function handleMessage(msg) {
            switch (msg.type) {
                case 'created':
                    mySymbol = msg.symbol;
                    document.getElementById('gameCode').textContent = msg.gameId;
                    document.getElementById('gameIdDisplay').style.display = 'flex';
                    document.getElementById('waitingMsg').style.display = 'block';
                    document.getElementById('joinSection').style.display = 'none';
                    break;

                case 'started':
                    mySymbol = msg.symbol;
                    opponentName = msg.opponentName;
                    myUsername = msg.yourUsername;
                    showGameScreen();
                    addLog('Game started! You are <span class="entry-' + mySymbol.toLowerCase() + '">' + mySymbol + '</span>. ' +
                        (msg.firstTurn === mySymbol ? 'Your turn!' : opponentName + ' goes first.'));
                    break;

                case 'gameState':
                    gameState = msg;
                    updateUI();
                    break;

                case 'actionResult':
                    handleActionResult(msg);
                    break;

                case 'gameOver':
                    handleGameOver(msg);
                    break;

                case 'error':
                    showToast(msg.message, 'fail');
                    document.getElementById('lobbyError').textContent = msg.message;
                    document.getElementById('lobbyError').style.display = 'block';
                    break;

                case 'opponentDisconnected':
                    document.getElementById('disconnectedBanner').style.display = 'block';
                    showToast('Opponent disconnected', 'fail');
                    break;
            }
        }

        // --- Lobby ---
        function createGame() {
            var username = document.getElementById('usernameInput').value.trim() || 'Player';
            document.getElementById('lobbyError').style.display = 'none';
            connectWS();
            ws.onopen = function() {
                sendMsg({ type: 'create', username: username });
            };
        }

        function showJoinSection() {
            document.getElementById('joinSection').style.display = 'flex';
            document.getElementById('gameIdDisplay').style.display = 'none';
            document.getElementById('waitingMsg').style.display = 'none';
            document.getElementById('lobbyError').style.display = 'none';
            document.getElementById('gameIdInput').focus();
        }

        function joinGame() {
            var username = document.getElementById('usernameInput').value.trim() || 'Player';
            var gameId = document.getElementById('gameIdInput').value.trim().toUpperCase();
            if (!gameId) {
                document.getElementById('lobbyError').textContent = 'Enter a game code';
                document.getElementById('lobbyError').style.display = 'block';
                return;
            }
            document.getElementById('lobbyError').style.display = 'none';
            connectWS();
            ws.onopen = function() {
                sendMsg({ type: 'join', gameId: gameId, username: username });
            };
        }

        function copyGameCode() {
            var code = document.getElementById('gameCode').textContent;
            navigator.clipboard.writeText(code).then(function() {
                showToast('Code copied!', 'success');
            });
        }

        function showGameScreen() {
            document.getElementById('lobby').style.display = 'none';
            document.getElementById('gameScreen').style.display = 'flex';
            document.getElementById('gameScreen').style.flexDirection = 'column';
            document.getElementById('gameScreen').style.alignItems = 'center';
            document.getElementById('gameScreen').style.gap = '20px';
        }

        function backToLobby() {
            if (ws) { ws.close(); ws = null; }
            mySymbol = null;
            gameState = null;
            isGameOver = false;
            selectedCell = -1;
            selectedAction = '';
            document.getElementById('lobby').style.display = 'flex';
            document.getElementById('gameScreen').style.display = 'none';
            document.getElementById('gameIdDisplay').style.display = 'none';
            document.getElementById('waitingMsg').style.display = 'none';
            document.getElementById('joinSection').style.display = 'none';
            document.getElementById('lobbyError').style.display = 'none';
            document.getElementById('disconnectedBanner').style.display = 'none';
            document.getElementById('log').innerHTML = '';
        }

        // --- Game UI ---
        function updateUI() {
            if (!gameState) return;

            var xName = gameState.players.X || 'X';
            var oName = gameState.players.O || 'O';

            // Labels: show "(You)" suffix for the player's own side
            document.getElementById('labelX').textContent = xName + (mySymbol === 'X' ? ' (You)' : '');
            document.getElementById('labelO').textContent = oName + (mySymbol === 'O' ? ' (You)' : '');

            var oppSymbol = mySymbol === 'X' ? 'O' : 'X';
            document.getElementById('money' + mySymbol).textContent = '$' + gameState.money[mySymbol];
            document.getElementById('money' + oppSymbol).textContent = '$???';

            document.getElementById('playerX').classList.toggle('active', gameState.currentTurn === 'X' && !gameState.gameOver);
            document.getElementById('playerO').classList.toggle('active', gameState.currentTurn === 'O' && !gameState.gameOver);

            var isMyTurn = gameState.currentTurn === mySymbol && !gameState.gameOver;

            // Turn action pills
            var actionsEl = document.getElementById('turnActions');
            var pillPlace = document.getElementById('pillPlace');
            var pillRemove = document.getElementById('pillRemove');
            var endBtn = document.getElementById('endTurnBtn');

            if (isMyTurn && gameState.turnState) {
                actionsEl.style.display = 'flex';
                pillPlace.className = 'action-pill ' + (gameState.turnState.placed ? 'used' : 'available');
                pillRemove.className = 'action-pill ' + (gameState.turnState.removed ? 'used' : 'available');

                if (gameState.turnState.placed || gameState.turnState.removed) {
                    endBtn.classList.add('visible');
                } else {
                    endBtn.classList.remove('visible');
                }

                if (!gameState.turnState.placed && !gameState.turnState.removed) {
                    setStatus('Your turn — place, remove, or both');
                } else if (gameState.turnState.placed && !gameState.turnState.removed) {
                    setStatus('You can also remove, or end turn');
                } else if (!gameState.turnState.placed && gameState.turnState.removed) {
                    setStatus('You can also place, or end turn');
                } else {
                    setStatus('Both actions used');
                }
            } else if (!gameState.gameOver) {
                actionsEl.style.display = 'none';
                endBtn.classList.remove('visible');
                setStatus(opponentName + "'s turn...");
            } else {
                actionsEl.style.display = 'none';
                endBtn.classList.remove('visible');
            }

            renderBoard();
        }

        function renderBoard() {
            if (!gameState) return;
            var boardEl = document.getElementById('board');
            boardEl.innerHTML = '';
            for (var i = 0; i < 9; i++) {
                var cell = document.createElement('div');
                cell.className = 'cell';
                cell.dataset.index = i;
                if (gameState.board[i] !== 0) {
                    var mark = document.createElement('span');
                    mark.className = gameState.board[i] === 'X' ? 'x-mark' : 'o-mark';
                    mark.textContent = gameState.board[i];
                    cell.appendChild(mark);

                    var tag = document.createElement('span');
                    tag.className = 'bid-tag';
                    if (gameState.bids[i] !== null && gameState.bids[i] !== '?') {
                        tag.textContent = '$' + gameState.bids[i];
                        cell.classList.add('reveal-bid');
                    } else {
                        tag.textContent = '$?';
                    }
                    cell.appendChild(tag);
                }
                cell.addEventListener('click', (function(idx) {
                    return function() { onCellClick(idx); };
                })(i));
                boardEl.appendChild(cell);
            }
        }

        function setStatus(text, cls) {
            var el = document.getElementById('status');
            el.textContent = text;
            el.className = 'status' + (cls ? ' ' + cls : '');
        }

        // --- Player Actions ---
        function onCellClick(idx) {
            if (!gameState || isGameOver) return;
            if (gameState.currentTurn !== mySymbol) {
                showToast('Not your turn!', 'info');
                return;
            }
            if (gameState.money[mySymbol] < 1) {
                showToast('You have no money left!', 'fail');
                return;
            }

            var oppSymbol = mySymbol === 'X' ? 'O' : 'X';

            if (gameState.board[idx] === 0) {
                // Place
                if (gameState.turnState && gameState.turnState.placed) {
                    showToast('Already placed this turn!', 'info');
                    return;
                }
                selectedCell = idx;
                selectedAction = 'place';
                showModal('Place your coin', 'How much will you bid for cell ' + (idx + 1) + '?');
            } else if (gameState.board[idx] === oppSymbol) {
                // Remove attempt
                if (gameState.turnState && gameState.turnState.removed) {
                    showToast('Already tried a remove this turn!', 'info');
                    return;
                }
                selectedCell = idx;
                selectedAction = 'remove';
                showModal("Remove opponent's coin", "Bid more than their hidden bid on cell " + (idx + 1) + " to remove it.");
            } else {
                showToast("That's already your spot!", 'info');
            }
        }

        function showModal(title, desc) {
            document.getElementById('modalTitle').textContent = title;
            document.getElementById('modalDesc').textContent = desc;
            var input = document.getElementById('bidInput');
            input.max = gameState.money[mySymbol];
            input.value = Math.min(5, gameState.money[mySymbol]);
            document.getElementById('modal').classList.add('show');
            input.focus();
            input.select();
        }

        function hideModal() {
            document.getElementById('modal').classList.remove('show');
        }

        function confirmBid() {
            var input = document.getElementById('bidInput');
            var bid = parseInt(input.value);

            if (isNaN(bid) || bid < 1) {
                showToast('Minimum bid is $1!', 'fail');
                return;
            }
            if (bid > gameState.money[mySymbol]) {
                showToast("You don't have enough money!", 'fail');
                return;
            }

            hideModal();
            sendMsg({ type: selectedAction, cell: selectedCell, bid: bid });
        }

        function endTurn() {
            sendMsg({ type: 'endTurn' });
        }

        // --- Action Results ---
        function handleActionResult(msg) {
            if (msg.action === 'place' && msg.success) {
                addLog('You placed <span class="entry-' + mySymbol.toLowerCase() + '">' + mySymbol + '</span> on cell ' + (msg.cell + 1) + ' for <span class="entry-gold">$' + msg.bid + '</span>');
            } else if (msg.action === 'remove') {
                if (msg.success) {
                    addLog('You removed opponent\'s coin from cell ' + (msg.cell + 1) + ' (<span class="entry-gold">$' + msg.bid + '</span> vs <span class="entry-gold">$' + msg.opponentBid + '</span>)');
                    showToast('Removed! They had bid $' + msg.opponentBid, 'success');
                } else {
                    addLog('Remove failed on cell ' + (msg.cell + 1) + ' (<span class="entry-gold">$' + msg.bid + '</span> vs <span class="entry-gold">$' + msg.opponentBid + '</span>). Lost <span class="entry-gold">$' + msg.bid + '</span>!');
                    showToast('Failed! They had bid $' + msg.opponentBid, 'fail');
                }
            }
        }

        // --- Game Over ---
        function handleGameOver(msg) {
            isGameOver = true;
            gameState = {
                board: msg.board,
                bids: msg.bids,
                money: msg.money,
                currentTurn: null,
                turnState: null,
                gameOver: true,
                yourSymbol: msg.yourSymbol,
                players: msg.players,
            };

            // Render board with all bids revealed
            var boardEl = document.getElementById('board');
            boardEl.innerHTML = '';
            for (var i = 0; i < 9; i++) {
                var cell = document.createElement('div');
                cell.className = 'cell reveal-bid';
                if (msg.board[i] !== 0) {
                    var mark = document.createElement('span');
                    mark.className = msg.board[i] === 'X' ? 'x-mark' : 'o-mark';
                    mark.textContent = msg.board[i];
                    cell.appendChild(mark);

                    var tag = document.createElement('span');
                    tag.className = 'bid-tag';
                    tag.textContent = '$' + msg.bids[i];
                    cell.appendChild(tag);
                }
                if (msg.winCells && msg.winCells.indexOf(i) !== -1) {
                    cell.classList.add('win-cell');
                }
                boardEl.appendChild(cell);
            }

            // Update money display
            document.getElementById('moneyX').textContent = '$' + (msg.money.X != null ? msg.money.X : '?');
            document.getElementById('moneyO').textContent = '$' + (msg.money.O != null ? msg.money.O : '?');

            // Hide turn UI
            document.getElementById('turnActions').style.display = 'none';
            document.getElementById('endTurnBtn').classList.remove('visible');
            document.getElementById('playerX').classList.remove('active');
            document.getElementById('playerO').classList.remove('active');

            if (msg.winner === null) {
                setStatus("It's a draw!", '');
                addLog('Game over — draw!');
            } else if (msg.winner === mySymbol) {
                setStatus('You win! Three in a row!', 'win');
                addLog('<span class="entry-' + mySymbol.toLowerCase() + '">You win!</span> Three in a row!');
            } else {
                setStatus(opponentName + ' wins! Three in a row.', 'lose');
                addLog('<span class="entry-' + msg.winner.toLowerCase() + '">' + opponentName + ' wins.</span> Three in a row.');
            }
        }

        // --- Helpers ---
        function showToast(msg, type) {
            var toast = document.getElementById('toast');
            toast.textContent = msg;
            toast.className = 'toast ' + type + ' show';
            clearTimeout(toast._timeout);
            toast._timeout = setTimeout(function() {
                toast.classList.remove('show');
            }, 2500);
        }

        function addLog(html) {
            var el = document.getElementById('log');
            el.innerHTML += '<div>' + html + '</div>';
            el.scrollTop = el.scrollHeight;
        }

        function toggleRules() {
            document.getElementById('rulesPanel').classList.toggle('show');
        }

        // Modal events
        document.getElementById('modal').addEventListener('click', function(e) {
            if (e.target === this) hideModal();
        });
        document.getElementById('bidInput').addEventListener('keydown', function(e) {
            if (e.key === 'Enter') confirmBid();
        });
        document.getElementById('gameIdInput').addEventListener('keydown', function(e) {
            if (e.key === 'Enter') joinGame();
        });
    </script>
</body>
</html>
